--==============================================================
-- GỘP SCRIPT: TP NHANH + BLACKSCREEN + FULL BAG 40/ROUND + SAFE
-- Giữ đầy đủ chức năng của cả 2 script, tối ưu & chống rớt map
--==============================================================

--=========================
-- 1) CONFIG CƠ BẢN
--=========================
getgenv().Config = {
    FPS = 3;                 -- FPS cap
    Speed = 30;               -- Tốc độ Tween khi cần
    BlackScreen = true;       -- Màn hình đen + HUD
    WEBHOOK_URL = "";         -- (giữ nguyên – chưa dùng ở đây)
    WEBHOOK_NOTE = "";
}

local FULL_BAG_PER_ROUND = 40   -- YÊU CẦU: full bag = 40/round (không lấy từ config)
local MIN_PLAYERS = 4           -- YÊU CẦU: min players = 4 (hardcode)

--=========================
-- 2) SAFE cloneref + GetService cache
--=========================
getgenv().cloneref = cloneref or function(x) return x end
local Services = setmetatable({}, {
    __index = function(self, Ind)
        local ok, res = pcall(function() return game:GetService(Ind) end)
        if ok and res then
            res = cloneref(res)
            rawset(self, Ind, res)
            return res
        end
        return nil
    end
})

local Players            = Services.Players
local RunService         = Services.RunService
local TweenService       = Services.TweenService
local HttpService        = Services.HttpService
local ReplicatedStorage  = Services.ReplicatedStorage
local Lighting           = Services.Lighting
local TeleportService    = Services.TeleportService
local GuiService         = Services.GuiService
local CoreGui            = Services.CoreGui
local CollectionService  = Services.CollectionService

repeat task.wait(0.2) until game:IsLoaded() and Players and Players.LocalPlayer
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

--=========================
-- 3) AUTO CLICK NÚT PLAY/DEVICESELECT (hợp nhất cách làm)
--=========================
local function clickPlayAndDevice()
    local button, deviceSelect
    local function refreshHandles()
        local join = PlayerGui:FindFirstChild("Join")
        if join and join:FindFirstChild("Friends") and join.Friends:FindFirstChild("Play") then
            button = join.Friends.Play
        end
        deviceSelect = PlayerGui:FindFirstChild("DeviceSelect")
    end

    local function fireAllConnections(btn)
        for _, v in ipairs(getconnections(btn.MouseButton1Click)) do
            if v.Function then pcall(v.Function) end
        end
    end

    repeat
        task.wait()
        if not button or not deviceSelect then
            refreshHandles()
        end
    until button or deviceSelect

    if button then fireAllConnections(button) end
    if deviceSelect and deviceSelect:FindFirstChild("Container") then
        local tablet = deviceSelect.Container:FindFirstChild("Tablet")
        local tabletButton = tablet and tablet:FindFirstChild("Button")
        if tabletButton then fireAllConnections(tabletButton) end
    end

    task.wait(3)
    -- Thử lại 1 lần nữa cho chắc
    if not button then
        refreshHandles()
        if button then fireAllConnections(button) end
    end
    if not deviceSelect then
        refreshHandles()
        if deviceSelect and deviceSelect:FindFirstChild("Container") then
            local tablet = deviceSelect.Container:FindFirstChild("Tablet")
            local tabletButton = tablet and tablet:FindFirstChild("Button")
            if tabletButton then fireAllConnections(tabletButton) end
        end
    end
end

task.spawn(clickPlayAndDevice)

--=========================
-- 4) BLACK SCREEN + HUD (Time / Total / +count) + đổi màu ≥ 90000
--=========================
local screenRoot, timeLabel, totalLabel, plusLabel
local labelSource -- TextLabel trong UI game làm nguồn "Total"
local totalCount = 0 -- số lần Total thay đổi (đếm +)
local startTime = tick()

local function safeFindSourceLabel()
    -- Đường dẫn theo yêu cầu (có thể fail trên map khác) -> bọc pcall
    local ok, res = pcall(function()
        return PlayerGui
        :WaitForChild("CrossPlatform", 5)
        :WaitForChild("Summer2025", 5)
        :WaitForChild("Container", 5)
        :WaitForChild("EventFrames", 5)
        :WaitForChild("BattlePass", 5)
        :WaitForChild("Info", 5)
        :WaitForChild("Tokens", 5)
        :WaitForChild("Container", 5)
        :WaitForChild("TextLabel", 5)
    end)
    if ok then return res end
    return nil
end

local function setupBlackHUD()
    if not (getgenv().Config and getgenv().Config.BlackScreen) then return end

    local BlankScreen = PlayerGui:FindFirstChild("Blank") or Instance.new("ScreenGui")
    BlankScreen.Name = "Blank"
    BlankScreen.ResetOnSpawn = false
    BlankScreen.DisplayOrder = 10000
    BlankScreen.IgnoreGuiInset = true
    BlankScreen.Parent = PlayerGui

    local Black = BlankScreen:FindFirstChild("Black Screen") or Instance.new("Frame")
    Black.Name = "Black Screen"
    Black.Size = UDim2.new(1, 0, 1, 0)
    Black.BackgroundColor3 = Color3.new(0, 0, 0)
    Black.ZIndex = 9999
    Black.Visible = true
    Black.Parent = BlankScreen

    screenRoot = BlankScreen:FindFirstChild("FullscreenTextDisplay") or Instance.new("ScreenGui")
    screenRoot.Name = "FullscreenTextDisplay"
    screenRoot.ResetOnSpawn = false
    screenRoot.IgnoreGuiInset = true
    screenRoot.DisplayOrder = 10001
    screenRoot.Parent = BlankScreen

    timeLabel = screenRoot:FindFirstChild("TimeLabel") or Instance.new("TextLabel")
    timeLabel.Name = "TimeLabel"
    timeLabel.Size = UDim2.new(1, 0, 0.1, 0)
    timeLabel.Position = UDim2.new(0, 0, 0.25, 0)
    timeLabel.BackgroundTransparency = 1
    timeLabel.TextColor3 = Color3.new(1, 1, 1)
    timeLabel.TextStrokeTransparency = 0.5
    timeLabel.Font = Enum.Font.GothamBold
    timeLabel.TextScaled = true
    timeLabel.TextWrapped = true
    timeLabel.Text = "Time: 00:00:00"
    timeLabel.Parent = screenRoot

    totalLabel = screenRoot:FindFirstChild("MiddleLabel") or Instance.new("TextLabel")
    totalLabel.Name = "MiddleLabel"
    totalLabel.Size = UDim2.new(1, 0, 0.2, 0)
    totalLabel.Position = UDim2.new(0, 0, 0.4, 0)
    totalLabel.BackgroundTransparency = 1
    totalLabel.TextColor3 = Color3.new(1, 1, 1)
    totalLabel.TextStrokeTransparency = 0.5
    totalLabel.Font = Enum.Font.GothamBold
    totalLabel.TextScaled = true
    totalLabel.TextWrapped = true
    totalLabel.Text = "Total : ..."
    totalLabel.Parent = screenRoot

    plusLabel = screenRoot:FindFirstChild("CountLabel") or Instance.new("TextLabel")
    plusLabel.Name = "CountLabel"
    plusLabel.Size = UDim2.new(1, 0, 0.2, 0)
    plusLabel.Position = UDim2.new(0, 0, 0.55, 0)
    plusLabel.BackgroundTransparency = 1
    plusLabel.TextColor3 = Color3.new(1, 1, 1)
    plusLabel.TextStrokeTransparency = 0.5
    plusLabel.Font = Enum.Font.GothamBold
    plusLabel.TextScaled = true
    plusLabel.TextWrapped = true
    plusLabel.Text = "+0"
    plusLabel.Parent = screenRoot

    -- Lấy source label (nếu có)
    labelSource = safeFindSourceLabel()
    if labelSource then
        totalLabel.Text = "Total : " .. labelSource.Text
        -- Theo dõi thay đổi để cộng + và đổi màu khi >= 90000
        local lastDigits = labelSource.Text:gsub("%D", "")
        labelSource:GetPropertyChangedSignal("Text"):Connect(function()
            local currentDigits = labelSource.Text:gsub("%D", "")
            if currentDigits ~= lastDigits and lastDigits ~= "" then
                local value = tonumber(currentDigits)
                if value then
                    totalCount += 1
                    totalLabel.Text = "Total : " .. labelSource.Text
                    plusLabel.Text = "+" .. tostring(totalCount)
                    if value >= 90000 then
                        -- nền xanh lá khi đạt ngưỡng
                        Black.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
                    else
                        Black.BackgroundColor3 = Color3.new(0, 0, 0)
                    end
                end
            end
            lastDigits = currentDigits
        end)
    end

    -- Đồng hồ chạy
    task.spawn(function()
        while screenRoot and screenRoot.Parent do
            task.wait(1)
            local elapsed = math.floor(tick() - startTime)
            local h = math.floor(elapsed / 3600)
            local m = math.floor((elapsed % 3600) / 60)
            local s = elapsed % 60
            timeLabel.Text = string.format("Time: %02d:%02d:%02d", h, m, s)
        end
    end)
end

task.spawn(setupBlackHUD)

--=========================
-- 5) Giảm đồ hoạ/ẩn hiệu ứng (boostFPS)
--=========================
local function boostFPS()
    pcall(function()
        loadstring(game:HttpGet('https://raw.githubusercontent.com/NoriCoder/gh/refs/heads/main/q'))()
    end)
    local Terrain = workspace:FindFirstChildOfClass('Terrain')
    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 1
    end
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 9e9
    Lighting.FogStart = 9e9
    pcall(function() settings().Rendering.QualityLevel = 1 end)

    -- Ẩn bớt visual
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Material = Enum.Material.Plastic
            v.Reflectance = 0
            v.Transparency = v.Transparency -- giữ như cũ (script trên để 1, mình không ép 100% để tránh lỗi map)
        elseif v:IsA("Decal") then
            v.Transparency = v.Transparency
        elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
            v.Lifetime = NumberRange.new(0)
        end
    end
    for _, v in ipairs(Lighting:GetDescendants()) do
        if v:IsA("PostEffect") then v.Enabled = false end
    end
end

-- Tùy chọn bật sau vài giây, có thể comment nếu không cần
task.defer(boostFPS)

--=========================
-- 6) Chống rớt map: SafePart + NaN FallenPartsDestroyHeight
--=========================
local function createPartSafe(target)
    if not target or not target.CFrame then return end
    local old = workspace:FindFirstChild("SafePart")
    if old then old:Destroy() end

    local safepart = Instance.new("Part")
    safepart.Size = Vector3.new(50, 0.5, 50)
    safepart.CFrame = target.CFrame * CFrame.new(0, -8, 0)
    safepart.Name = "SafePart"
    safepart.Parent = workspace
    safepart.Anchored = true
    safepart.Massless = true
    safepart.Transparency = 1
end

-- NaN trick
task.spawn(function()
    while task.wait(1) do
        pcall(function()
            workspace.FallenPartsDestroyHeight = (0/0)
        end)
    end
end)

--=========================
-- 7) Tiện ích TP & tìm coin
--=========================
local Character, Humanoid, HumanoidRootPart
LocalPlayer.CharacterAdded:Connect(function(v)
    Character = v
    Humanoid = v:WaitForChild("Humanoid")
    HumanoidRootPart = v:WaitForChild("HumanoidRootPart")
end)
if LocalPlayer.Character then
    Character = LocalPlayer.Character
    Humanoid = Character:FindFirstChild("Humanoid") or Character:WaitForChild("Humanoid")
    HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart") or Character:WaitForChild("HumanoidRootPart")
end

local function tweenTo(cf)
    if not HumanoidRootPart then return end
    local dist = (cf.Position - HumanoidRootPart.Position).Magnitude
    TweenService:Create(HumanoidRootPart, TweenInfo.new(
        dist / (getgenv().Config.Speed or 20),
        Enum.EasingStyle.Linear
    ), {CFrame = cf}):Play()
end

local function pcallTP(part)
    if Character and HumanoidRootPart and part and part.CFrame then
        Character:SetPrimaryPartCFrame(part.CFrame * CFrame.new(0, 2, 0))
        -- Chờ TouchInterest biến mất => ăn coin xong
        local ti = part:FindFirstChildWhichIsA("TouchTransmitter")
        if ti then
            local t0 = tick()
            repeat task.wait() until not part:IsDescendantOf(workspace) or not part:FindFirstChildWhichIsA("TouchTransmitter") or tick() - t0 > 2
        end
        return true
    end
    return false
end

local function coinContainer()
    -- Ưu tiên Container kiểu script trên
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("Model") and v.Name == "CoinContainer" then
            return v
        elseif v:IsA("Part") and v.Name == "Coin_Server" then
            return v.Parent
        end
    end
    return nil
end

local function findNearestCoinFromContainer(container)
    if not HumanoidRootPart or not container then return nil end
    local coin, best = nil, math.huge
    for _, v in ipairs(container:GetChildren()) do
        if v:IsA("BasePart") and v:FindFirstChildWhichIsA("TouchTransmitter") then
            local d = (HumanoidRootPart.Position - v.Position).Magnitude
            if d < best then best = d coin = v end
        end
    end
    if best <= 50 then return coin end
    return nil
end

local function getNearestTaggedCoin()
    if not HumanoidRootPart then return nil end
    local nearest, nearestDist = nil, 2000
    for _, v in ipairs(CollectionService:GetTagged("ServerCoinPart")) do
        if v and v:IsA("BasePart") and v:GetAttribute("CoinID") ~= nil and v:GetAttribute("Collected") == nil and v:FindFirstChildWhichIsA("TouchTransmitter") then
            local dist = (HumanoidRootPart.Position - v.Position).Magnitude
            if dist < nearestDist then nearestDist = dist nearest = v end
        end
    end
    return nearest
end

--=========================
-- 8) ALTFILTER (giữ theo script trên)
--=========================
local function checkAlt()
    local count = 0
    local ok, listAlt = pcall(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/Fedtfuyu/fedscript/refs/heads/main/fedscripts"))()
    end)
    if ok and type(listAlt) == "table" then
        for _, plr in ipairs(Players:GetPlayers()) do
            if table.find(listAlt, plr.Name) then count += 1 end
        end
    end
    return count
end

task.spawn(function()
    local status = checkAlt()
    if status > 4 then
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end
end)

--=========================
-- 9) AUTO REJOIN & LỖI KẾT NỐI
--=========================
local retry = 0
local isTeleporting = false
local function rejoin()
    if RunService:IsStudio() then return end
    if isTeleporting then return end
    isTeleporting = true
    local ok, err = pcall(function()
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end)
    if not ok then
        if retry < 3 then
            retry += 1
            task.wait(5)
            isTeleporting = false
            rejoin()
        end
    end
end

local function checkAndRejoinByPlayerCount()
    if #Players:GetPlayers() < MIN_PLAYERS then
        rejoin()
    end
end

task.delay(3, checkAndRejoinByPlayerCount)
Players.PlayerRemoving:Connect(function(p)
    if p ~= LocalPlayer then
        task.delay(1, checkAndRejoinByPlayerCount)
    end
end)
task.spawn(function()
    while task.wait(20) do checkAndRejoinByPlayerCount() end
end)

-- ErrorPrompt auto TP lại
task.spawn(function()
    while task.wait(30) do
        pcall(function()
            local ErrorPrompt = CoreGui.RobloxPromptGui.promptOverlay:FindFirstChild("ErrorPrompt")
            if ErrorPrompt and not string.find(ErrorPrompt.MessageArea.ErrorFrame.ErrorMessage.Text, "is full") then
                TeleportService:Teleport(game.PlaceId, LocalPlayer)
            end
        end)
    end
end)

-- DisconnectErrors -> Teleport vòng lặp
GuiService.ErrorMessageChanged:Connect(newcclosure(function()
    if GuiService:GetErrorType() == Enum.ConnectionError.DisconnectErrors and not ({[9]=1,[10]=1,[13]=1,[17]=1,[18]=1,[21]=1,[26]=1})[GuiService:GetErrorCode()] then
        while true do TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer) task.wait(3) end
    end
end))

--=========================
-- 10) WATCHDOG: 300s không tăng total -> kick & teleport
--=========================
task.spawn(function()
    local ok, DataPlayer = pcall(function()
        return require(ReplicatedStorage.Modules.ProfileData)
    end)
    if not ok or not DataPlayer then return end
    local last = DataPlayer.Materials and DataPlayer.Materials.Owned and DataPlayer.Materials.Owned.BeachBalls2025 or 0
    while task.wait(300) do
        pcall(function()
            local cur = DataPlayer.Materials.Owned.BeachBalls2025
            if cur > last then
                last = cur
            else
                LocalPlayer:Kick("Server Error")
                TeleportService:Teleport(game.PlaceId, LocalPlayer)
            end
        end)
    end
end)

--=========================
-- 11) STATE ROUND & FULLBAG = 40
--=========================
local AutofarmIN = false
local FullEggBag = false
local pickCountThisRound = 0

-- Ưu tiên dùng Remote nếu tồn tại
local CoinCollectedEvent
local RoundStartEvent
local RoundEndEvent
pcall(function()
    CoinCollectedEvent = ReplicatedStorage.Remotes.Gameplay.CoinCollected
    RoundStartEvent   = ReplicatedStorage.Remotes.Gameplay.RoundStart
    RoundEndEvent     = ReplicatedStorage.Remotes.Gameplay.RoundEndFade
end)

if CoinCollectedEvent and CoinCollectedEvent.OnClientEvent then
    CoinCollectedEvent.OnClientEvent:Connect(function(cointype, current, max)
        -- Nếu game có trả current/max, vẫn giữ logic riêng FULL_BAG_PER_ROUND
        pickCountThisRound += 1
        if pickCountThisRound >= FULL_BAG_PER_ROUND then
            FullEggBag = true
            if Humanoid then Humanoid.Health = 0 end -- reset nhanh
        end
        AutofarmIN = true
    end)
end

if RoundStartEvent and RoundStartEvent.OnClientEvent then
    RoundStartEvent.OnClientEvent:Connect(function()
        AutofarmIN = true
        FullEggBag = false
        pickCountThisRound = 0
        totalCount = 0 -- reset +count hiển thị nếu muốn bắt đầu lại theo round
        if plusLabel then plusLabel.Text = "+0" end
    end)
end

if RoundEndEvent and RoundEndEvent.OnClientEvent then
    RoundEndEvent.OnClientEvent:Connect(function()
        AutofarmIN = false
        FullEggBag = false
        pickCountThisRound = 0
    end)
end

-- Fallback bật/tắt Autofarm theo GUI nếu không có Remote (song song, không hại)
task.spawn(function()
    while task.wait(1) do
        local ok, panel = pcall(function()
            return PlayerGui.MainGUI.Game.CoinBags.Container.BeachBall
        end)
        if ok and panel and panel.Visible then
            AutofarmIN = true
        else
            if not FullEggBag then
                -- chỉ tắt nếu chưa full, tránh loop tắt mở ngay sau full
                AutofarmIN = false
            end
        end
    end
end)

--=========================
-- 12) VÒNG LẶP NHẶT COIN (TP nhanh + chain coin gần nhất + safe)
--=========================
setfpscap(getgenv().Config and getgenv().Config.FPS or 0)

task.spawn(function()
    -- loop chính
    while task.wait(0.3) do
        if not AutofarmIN or FullEggBag then
            continue
        end
        if not Character or not HumanoidRootPart then
            continue
        end

        local cont = coinContainer()
        if cont then
            -- Ưu tiên dùng container (script trên)
            pcall(function()
                for _, v in ipairs(cont.Parent and cont.Parent:GetDescendants() or {}) do
                    if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
                end
            end)

            -- Lặp nhặt coin trong container
            while task.wait() do
                if not AutofarmIN or FullEggBag then break end
                if not cont or not cont.Parent then break end

                local list = cont:GetChildren()
                if #list == 0 then break end

                -- lấy coin random -> TP nhanh
                local coin = list[math.random(1, #list)]
                if coin:IsA("BasePart") and coin:FindFirstChildWhichIsA("TouchTransmitter") then
                    pcall(function()
                        createPartSafe(coin)
                        task.wait(0.02)
                        pcallTP(coin)
                        pickCountThisRound += 1
                        if pickCountThisRound >= FULL_BAG_PER_ROUND then
                            FullEggBag = true
                            if Humanoid then Humanoid.Health = 0 end
                            return
                        end

                        -- chain tới 4 coin gần nhất (như script trên)
                        local count = 0
                        while task.wait(0.25) do
                            if count >= 4 or FullEggBag or not AutofarmIN then break end
                            local nearCoin = findNearestCoinFromContainer(cont)
                            if not nearCoin then break end
                            createPartSafe(nearCoin)
                            task.wait(0.02)
                            pcallTP(nearCoin)
                            pickCountThisRound += 1
                            if pickCountThisRound >= FULL_BAG_PER_ROUND then
                                FullEggBag = true
                                if Humanoid then Humanoid.Health = 0 end
                                break
                            end
                            count += 1
                        end
                        task.wait(0.5)
                    end)
                end
            end
        else
            -- Fallback: dùng tag CollectionService ("ServerCoinPart") như script dưới
            local v = getNearestTaggedCoin()
            if v and v:IsA("BasePart") then
                if (v.Position - HumanoidRootPart.Position).Magnitude <= 15 then
                    pcallTP(v)
                else
                    tweenTo(v.CFrame)
                end
                pickCountThisRound += 1
                if pickCountThisRound >= FULL_BAG_PER_ROUND then
                    FullEggBag = true
                    if Humanoid then Humanoid.Health = 0 end
                end
            end
        end
    end
end)
